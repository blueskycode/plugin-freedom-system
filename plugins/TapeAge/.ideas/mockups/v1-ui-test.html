<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=800, height=600">
  <title>TAPE AGE (Browser Test)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
      cursor: default;
    }

    body {
      width: 800px;
      height: 600px;
      background: #f5f0e8;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      position: relative;
    }

    /* Subtle texture overlay */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" /></filter><rect width="100" height="100" filter="url(%23noise)" opacity="0.15" /></svg>');
      pointer-events: none;
      opacity: 0.15;
    }

    #container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 40px 0;
    }

    /* VU Meter Section */
    #vu-meter-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    #vu-meter {
      width: 500px;
      height: 120px;
      background: #e8dfd0;
      border: 2px solid #7d5a3b;
      border-radius: 4px;
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #vu-canvas {
      width: 100%;
      height: 100%;
    }

    /* Title Section */
    #title {
      color: #3a2f24;
      font-size: 24px;
      font-weight: 300;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      text-align: center;
      margin: 30px 0;
    }

    /* Controls Section */
    #controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 70px;
      margin-bottom: 20px;
    }

    .knob-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .knob {
      width: 100px;
      height: 100px;
      background: radial-gradient(circle at 30% 30%, #d4a960, #c89f5d 50%, #a67c3a);
      border-radius: 50%;
      position: relative;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2),
                  inset 0 1px 3px rgba(255, 255, 255, 0.3),
                  inset 0 -2px 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.05s ease;
    }

    .knob:active {
      transform: scale(0.98);
    }

    .knob-indicator {
      position: absolute;
      top: 10px;
      left: 50%;
      width: 3px;
      height: 35px;
      background: #3a2f24;
      transform-origin: bottom center;
      transform: translateX(-50%);
      border-radius: 2px;
    }

    .knob-label {
      color: #3a2f24;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .knob-value {
      color: #7d5a3b;
      font-size: 10px;
      font-weight: 400;
      margin-top: 4px;
    }

    /* Debug console */
    #debug-console {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      font-family: monospace;
      font-size: 10px;
      padding: 8px;
      border-radius: 4px;
      max-width: 300px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
    }

    .log-entry {
      margin: 2px 0;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="vu-meter-section">
      <div id="vu-meter">
        <canvas id="vu-canvas"></canvas>
      </div>
    </div>

    <div id="title">TAPE AGE</div>

    <div id="controls">
      <div class="knob-container">
        <div class="knob" id="drive-knob" data-param="drive" data-value="0.5">
          <div class="knob-indicator"></div>
        </div>
        <div class="knob-label">DRIVE</div>
        <div class="knob-value" id="drive-value">50%</div>
      </div>

      <div class="knob-container">
        <div class="knob" id="age-knob" data-param="age" data-value="0.25">
          <div class="knob-indicator"></div>
        </div>
        <div class="knob-label">AGE</div>
        <div class="knob-value" id="age-value">25%</div>
      </div>

      <div class="knob-container">
        <div class="knob" id="mix-knob" data-param="mix" data-value="1.0">
          <div class="knob-indicator"></div>
        </div>
        <div class="knob-label">MIX</div>
        <div class="knob-value" id="mix-value">100%</div>
      </div>
    </div>
  </div>

  <div id="debug-console">
    <div class="log-entry">[Browser Test Mode]</div>
    <div class="log-entry">JUCE integration mocked</div>
  </div>

  <script>
    // Mock JUCE integration for browser testing
    const mockJUCE = {
      getSliderState: (paramId) => {
        console.log(`[MOCK] getSliderState("${paramId}")`);
        return {
          setNormalisedValue: (value) => {
            debugLog(`[${paramId}] setNormalisedValue(${value.toFixed(3)})`);
          },
          valueChangedEvent: {
            addListener: (callback) => {
              console.log(`[MOCK] Listener added for ${paramId}`);
            }
          }
        };
      }
    };

    function debugLog(message) {
      const console = document.getElementById('debug-console');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = message;
      console.appendChild(entry);
      console.scrollTop = console.scrollHeight;

      // Keep only last 10 entries
      while (console.children.length > 12) {
        console.removeChild(console.children[2]); // Keep header entries
      }
    }

    // VU Meter setup
    const canvas = document.getElementById('vu-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 500;
    canvas.height = 120;

    let currentLevel = -20; // dB
    let targetLevel = -20;
    let needleAngle = 0;

    function drawVUMeter() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw scale markings
      ctx.strokeStyle = '#3a2f24';
      ctx.lineWidth = 1;
      ctx.font = '10px sans-serif';
      ctx.fillStyle = '#3a2f24';
      ctx.textAlign = 'center';

      const dbValues = [-60, -40, -20, -10, -7, -5, -3, 0, 3, 6];
      const centerX = canvas.width / 2;
      const centerY = 100;
      const radius = 80;
      const startAngle = -140 * Math.PI / 180;
      const endAngle = -40 * Math.PI / 180;

      dbValues.forEach(db => {
        const normalized = (db + 60) / 66; // Map -60 to 6 dB
        const angle = startAngle + normalized * (endAngle - startAngle);
        const x1 = centerX + Math.cos(angle) * (radius - 10);
        const y1 = centerY + Math.sin(angle) * (radius - 10);
        const x2 = centerX + Math.cos(angle) * radius;
        const y2 = centerY + Math.sin(angle) * radius;

        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        const textX = centerX + Math.cos(angle) * (radius + 15);
        const textY = centerY + Math.sin(angle) * (radius + 15);
        ctx.fillText(db.toString(), textX, textY);
      });

      // Draw needle
      const normalizedLevel = Math.max(0, Math.min(1, (currentLevel + 60) / 66));
      needleAngle = startAngle + normalizedLevel * (endAngle - startAngle);

      ctx.strokeStyle = '#d97946';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(needleAngle) * (radius - 5),
        centerY + Math.sin(needleAngle) * (radius - 5)
      );
      ctx.stroke();

      // Needle pivot
      ctx.fillStyle = '#3a2f24';
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
      ctx.fill();
    }

    function animateVUMeter() {
      // Smooth interpolation
      currentLevel += (targetLevel - currentLevel) * 0.1;

      // Simulate audio activity
      targetLevel = -20 + Math.random() * 15 - 7.5;

      drawVUMeter();
      requestAnimationFrame(animateVUMeter);
    }

    animateVUMeter();

    // Knob handling
    const knobs = document.querySelectorAll('.knob');
    let activeKnob = null;
    let startY = 0;
    let startValue = 0;

    function updateKnob(knob, value) {
      const normalized = Math.max(0, Math.min(1, value));
      knob.dataset.value = normalized;

      const indicator = knob.querySelector('.knob-indicator');
      const degrees = -135 + (normalized * 270); // 270Â° range
      indicator.style.transform = `translateX(-50%) rotate(${degrees}deg)`;

      const paramId = knob.dataset.param;
      const valueDisplay = document.getElementById(`${paramId}-value`);
      valueDisplay.textContent = Math.round(normalized * 100) + '%';

      // Mock JUCE integration
      const state = mockJUCE.getSliderState(paramId);
      if (state) {
        state.setNormalisedValue(normalized);
      }
    }

    function handleKnobStart(e, knob) {
      e.preventDefault();
      activeKnob = knob;
      startY = e.clientY || e.touches[0].clientY;
      startValue = parseFloat(knob.dataset.value);
      debugLog(`Started dragging ${knob.dataset.param}`);
    }

    function handleKnobMove(e) {
      if (!activeKnob) return;
      e.preventDefault();

      const currentY = e.clientY || e.touches[0].clientY;
      const delta = (startY - currentY) / 200; // Sensitivity
      const newValue = startValue + delta;

      updateKnob(activeKnob, newValue);
    }

    function handleKnobEnd() {
      if (activeKnob) {
        debugLog(`Stopped dragging ${activeKnob.dataset.param}`);
      }
      activeKnob = null;
    }

    knobs.forEach(knob => {
      // Mouse events
      knob.addEventListener('mousedown', (e) => handleKnobStart(e, knob));

      // Touch events
      knob.addEventListener('touchstart', (e) => handleKnobStart(e, knob));

      // Initialize knob position
      updateKnob(knob, parseFloat(knob.dataset.value));

      // Mock JUCE bidirectional binding
      const paramId = knob.dataset.param;
      const state = mockJUCE.getSliderState(paramId);
      if (state) {
        state.valueChangedEvent.addListener((newValue) => {
          updateKnob(knob, newValue);
        });
      }
    });

    document.addEventListener('mousemove', handleKnobMove);
    document.addEventListener('mouseup', handleKnobEnd);
    document.addEventListener('touchmove', handleKnobMove);
    document.addEventListener('touchend', handleKnobEnd);

    // Disable context menu
    document.addEventListener('contextmenu', (e) => e.preventDefault());

    debugLog('UI loaded successfully');
  </script>
</body>
</html>
